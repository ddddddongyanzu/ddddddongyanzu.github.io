---
Layout: post
desc: java网络编程
title:  java网络编程
tag:  study
---

## Java 网络编程

#### 1.1 协议

通过网页，就能打开网页`https://www.douban.com/` 就可以访问网页等主页

##### 协议定义

​	协议，网络协议的简称，网页协议是通信计算机双方必须共同遵从的一组协议。

##### HTTP/HTTPS 协议

目前的两种协议，HTTP和HTTPS。区别如下

`	端口区别（80｜443）数据传输区别（明文传输｜加密传输）真假网站识别（很容易被复制｜使用证书很难被复制）门槛（不需要证书｜需要Gworg机构颁发证书，需要一定成本）安全性区别（很容易劫持，跳转到其他网站｜加密安全，很难劫持，交易数据加密）`

#### 1.2 URL

这个页面的地址比较复杂。地址栏输入的地址，叫做`URL(Uniform Resource Locator)`

```html
https://www.douban.com/gallery/topic/116390/?from=hot_topic_note&sort=new
```

格式说明:

- 协议类型与域名以 `://`（固定写法）分隔。
- 路径 （英文常称为path）以单斜杠`/`开头，中间每层的分隔符也是单斜杠`/`。
- 参数:

​			路径与参数之间用`？`分隔。

​			多个参数之间用`&`分隔

​			参数用"参数名=参数值" (key = value ) 的格式表示

端口号：

​			域名后面的 :4000 :8000 :443 : 80 这些端口

#### 2.1 Get请求

例如"中国科学技术大学"的网址（`https://www.ustc.edu.cn/`):

​	`Java`通过在`pom.xml`依赖中安装一个库`Okhttp3`以实现简单、快速的实现`HTTP`调用。

`pom.xml文件中的依赖为`

```xml
<!-- https://mvnrepository.com/artifact/com.squareup.okhttp3/okhttp -->
<dependency>
 <groupId>com.squareup.okhttp3</groupId>
 <artifactId>okhttp</artifactId>
 <version>4.1.0</version>
</dependency>
```

唯一的`<dependencies>`标签中, 包括多个<dependency>标签，每个标签表示一个依赖库.



使用`Okhttp3`完成页面请求，需要三大步骤:

1. 实例化`OkhttpClient`。使用`okHttpClient okHttpClient = new OkHttpClient();`

2. 执行调用。

- 在执行调用之前，需要实例化一个`Request`对象，作用是定义请求的各种参数

`Request request = new Request.Builder().url(url).build();`

- 然后构造调用对象

`Call call =okHttpClient.newCall(request);`

- 最后执行调用，如果调用失败可能抛异常，所以抓取异常。`call。execute()`就是调用代码.

3. `Call.execute()`返回的其实是一个可执行的结果对象，调用对象的方法既可以获取返回的字符串内容；

`call.execute().body().string();`



以上都是固定写法，一般都会将其固定步骤封装在一个getContent()方法里，容易复用和理解.



由于`call.execute().body().string();`可以取得服务器返回的具体内容。

在`console`中有大量的文本内容，这是给浏览器识别的内容，包括了许多无效的内容。所以很多时候，我们使用程序调用API，获得到需要的数据。



API : Application Programming Interface , 应用程序接口，API一般是指一些预先定义的函数，目的是为开发人员快速访问某一程序而不需要了解和访问源码，或理解它内部工作机制的细节。



简单地讲，API可以快速调用某个程序。在计算机中叫做接口

调用API ；

比如查询某个地方的天气

```
http://www.weather.com.cn/data/sk/101210106.html
```

把这个 URL 贴到浏览器，可以看到查询返回结果为：



```json
{
  "weatherinfo": {
    "city": "浣欐澀",
    "cityid": "101210106",
    "temp": "24",
    "WD": "鍖楅",
    "WS": "灏忎簬3绾�",
    "SD": "77%",
    "AP": "1000.7hPa",
    "njd": "鏆傛棤瀹炲喌",
    "WSE": "<3",
    "time": "17:50",
    "sm": "3.6",
    "isRadar": "0",
    "Radar": ""
  }
}
```

返回的内容没有大量多余的字符，`API`返回的内容统称为`数据`

代码用法:



```java
public class GetPage {

  /**

   * 根据输入的url，读取页面内容并返回
     */
    public String getContent(String url) {
					OkHttpClient okHttpClient = new OkHttpClient();
					Request request = new Request.Builder().url(url).build();
					Call call = okHttpClient.newCall(request);
		// 返回结果字符串
		String result = null;
		try {
  			result = call.execute().body().toString();	
					} catch (IOException e) {
  					e.printStackTrace();
								}
				return result;} 
```
```java
public static void main(String[] args) {
    GetPage getPage = new GetPage();
    String url = "https://www.fastmock.site/mock/3d95acf3f26358ef032d8a23bfdead99/api/musicRankings";
    String content = getPage.getContent(url);
		System.out.println("API调用结果");
		System.out.println(content);  }
}
```
#### 2.2 POST表单数据

post()方法

`Okhttp3`库也支持`post`操作。前面学习的调用`API`属于`get`操作。不同的是，`POST`操作时，数据不是放在`URL`中的，而是放在表单中提交的。

所以需要构建一个`FormBody`表单对象，用于放置表单对象，用于放置表单数据。

```java
Builder builder = new FormBody.Builder();
// 设置数据，第一个参数是数据名，第二个参数是数据值
builder.add("", "");
FormBody formBody = builder.build();

Request request = new Request.Builder().url(url).post(formBody).build();
```

与`Get`请求差别如上。在发送表单数据的过程，封装`postContent()`方法，方便重用。





```java
public class FormPoster {

  public String postContent(String url, Map<String, String> formData) {
    // okHttpClient 实例
    OkHttpClient okHttpClient = new OkHttpClient();
    //post方式提交的数据
    FormBody.Builder builder = new FormBody.Builder();
    // 放入表单数据
    for (String key : formData.keySet()) {
      builder.add(key, formData.get(key));
    }
    // 构建 FormBody 对象
    FormBody formBody = builder.build();
    // 指定 post 方式提交FormBody
    Request request = new Request.Builder()
            .url(url)
            .post(formBody)
            // addHeader("Referer", ...) 这个知识点在后面的章节中学到，目前不要纠结
            .addHeader("Referer", "https://www.taobao.com")
            .build();
		// 使用client去请求
		Call call = okHttpClient.newCall(request);
		// 返回结果字符串
		String result = null;
		try {
  	// 获得返回结果
  	result = call.execute().body().string();
		} catch (IOException e) {
  	// 抓取异常
  	System.out.println("request " + url + " error . ");
  	e.printStackTrace();
		}
		return result;  }


```
```java
public static void main(String[] args) {
    String url = "http://tcc.taobao.com/cc/json/mobile_tel_segment.html";
Map<String, String> formData = new HashMap();
formData.put("tel","18370136568");

FormPoster poster = new FormPoster();
String content = poster.postContent(url, formData);
  
System.out.println("API调用结果");
System.out.println(content);  }
}
```
#### 2.3 POST JSON 数据

除了提交表单数据，也经常用到提交`JSON`数据。

跟表单数据提交方法一样，也是调用`post();`方法，只是参数不再使用`FormBody`对象，而是使用`RequestBody`

1. 将数据转化成 `JSON`格式的字符串，调用`JSON.toJSONString()`方法即可
2. 创建`RequestBody`实例，需要指定的提交类型是`application/json;charset=utf-8`

3. 构建 `Request`实例对象时，调用`.post(requestBody)`即表示使用`JSON`的方法提交数据。



```java
public class JsonPoster {

  private static final MediaType JSON_TYPE = MediaType.parse("application/json;charset=utf-8");

  /**

   * 向指定的 url 提交数据，以 json 的方式
     */
  public String postContent(String url, Map<String, String> datas) {
	// okHttpClient 实例
	OkHttpClient okHttpClient = new OkHttpClient();

	// 数据对象转换成 json 格式字符串
	String param = JSON.toJSONString(datas);
	//post方式提交的数据
	RequestBody requestBody = RequestBody.create(JSON_TYPE,param);

	Request request = new Request.Builder().url(url).post(requestBody).build();

	// 使用client去请求
	Call call = okHttpClient.newCall(request);
	// 返回结果字符串
	String result = null;
	try {
  // 获得返回结果
  result = call.execute().body().string();
	} catch (IOException e) {
  // 抓取异常
  System.out.println("request " + url + " error . ");
  e.printStackTrace();	
	}
	return result;  }
```




```java
public static void main(String[] args) {
    JsonPoster jsonPoster = new JsonPoster();
    String url = "https://www.fastmock.site/mock/3d95acf3f26358ef032d8a23bfdead99/api/posts\n" +
            "\n";
    Map<String, String> datas = new HashMap();
    datas.put("num","20190101");
    datas.put("name","王陆");
    datas.put("gender","男");
    datas.put("faculty","灵剑派");
    datas.put("discipline","无相剑骨");
    datas.put("class","一年一班");
    datas.put("startYear","2019");
		String content = jsonPoster.postContent(url,datas);

		System.out.println("API调用结果");
		System.out.println(content);  }
}
```

#### 3.1 Response -网页

为了获得响应的状态的状态码，可以使用`call.execute().code();`

通常即需要响应内容，也需要响应码的话，不能执行两次请求，一般使用

`import okhttp3.Response`

```java
// 执行请求
Response rep = call.execute();
// 获取响应状态码
int code = rep.code();
// 获取响应内容
String content = rep.body().string();
```

#### 3.2 Response -非文本文件

`Java`使用`okhttp3`库除了可以获取网页状态码和返回的文本内容，还可以请求到`图片`、`excel`等各种文件

图片文件的内容不是可以直接阅读的字符文本，只是二进制编码，需要软件解析图片的二进制编码数据，才能还原成图像显示。

使用`response.body().bytes();`获取返回的内容

```java
package com.youkeda.test.http;

import java.io.IOException;
import okhttp3.Call;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;

public class ExcelAsker {

  /**
   * 根据输入的url，读取页面内容并返回
   */
  public void getFile(String url) {
    // okHttpClient 实例
    OkHttpClient okHttpClient = new OkHttpClient();
    // 定义一个request
    Request request = new Request.Builder().url(url).build();
    try {
      // 执行请求
      Response response = okHttpClient.newCall(request).execute();
      byte[] bytes = response.body().bytes();
      System.out.println("excel 大小为： " +  bytes.length + " 字节");
    } catch (IOException e) {
      // 抓取异常
      System.out.println("request " + url + " error . ");
      e.printStackTrace();
    }
  }

  public static void main(String[] args) {
    String url = "https://style.youkeda.com/img/ham/course/py2/china-city-list.xlsx";
    ExcelAsker asker = new ExcelAsker();
    asker.getFile(url);
  }
}
```

#### 3.3 Response -JSON

对于经常调用`API` 的我们来说，很多`API`返回的文本内容是`JSON`格式的。

`JSON`是一段文本，也就是`Java`的字符串,是难以进行解析具体内容的，必须转换成`Java`的对象

前面已经使用过`fastjson`库把参数对象转换成`JSON`格式字符串，当然也可以把`JSON`转换成`Java`对象，方便后面分析。

```java
JSON.parseObject(String content , Map.class);
```

代码如下

```java
package com.youkeda.test.http;


import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import com.alibaba.fastjson.JSON;
import okhttp3.Call;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;

public class ApiAsker {

  /**
   * 根据输入的url，读取页面内容并返回
   */
  public String getContent(String url) {
    // okHttpClient 实例
    OkHttpClient okHttpClient = new OkHttpClient();
    // 定义一个request
    Request request = new Request.Builder().url(url).build();
    // 使用client去请求
    Call call = okHttpClient.newCall(request);
    // 返回结果字符串
    String result = null;
    try {
      // 执行请求
      Response response = call.execute();
      // 获取响应内容
      result = response.body().string();
    } catch (IOException e) {
      // 抓取异常
      System.out.println("request " + url + " error . ");
      e.printStackTrace();
    }
    return result;
  }

  public static void main(String[] args) {
    String url = "https://c.y.qq.com/soso/fcgi-bin/client_search_cp?aggr=1&cr=1&flag_qc=0&p=1&n=30&w=西海情歌&format=json";
    ApiAsker asker = new ApiAsker();
    String content = asker.getContent(url);

    System.out.println("查询结果文本：" + content);
    Map contentObj = JSON.parseObject(content,Map.class);
    System.out.println("JSON 格式字符串转换为 Map 对象");
  }
}
```

#### 3.4 解析JSON对象

对于解析调用的`API`结果，只需要多次取出嵌套的`Map`对象即可。

Map contentObj = JSON.parseObject(content , Map.class);

Map dataObj = (Map)contentObj.get("data");

String city = (String)dataObj.get("city");

因为`Map`可以存储任何对象，所以`Map`中`get()`到的对象必须指定其实际的类型：`(Map)、(String)`

```json
{
  "code": 0,
  "data": {
    "ip": "117.89.35.58",
    "country": "中国",
    "area": "",
    "region": "江苏",
    "city": "南京",
    "county": "XX",
    "isp": "电信",
    "country_id": "CN",
    "area_id": "",
    "region_id": "320000",
    "city_id": "320100",
    "county_id": "xx",
    "isp_id": "100017"
  }
}
```

代码省略

```java
Map contentObj = JSON.parseObject(content, Map.class);
Map dataObj = (Map)contentObj.get("data");
String city = (String)dataObj.get("city"); //解析出南京
```

#### 4 反爬虫(User-Agent/Referer/Host)

有些时候，有些`API`请求无法成功，这个时候就需要将`Java`程序请求模拟成一个真实的浏览器访问。

```java
Request request = new Request.Builder()
    .url(url)
    .addHeader("User-Agent", "...")  //用于请求Http不成功的情况
 		.addHeader("Referer","...") //用于解决程序访问图片失败情况
  	.addHeader("Host","...") //实现虚拟主机的作用
    .build();
```
